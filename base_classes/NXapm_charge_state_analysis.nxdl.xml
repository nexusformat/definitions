<?xml version='1.0' encoding='UTF-8'?>
<?xml-stylesheet type="text/xsl" href="nxdlformat.xsl"?>
<!--
# NeXus - Neutron and X-ray Common Data Format
#
# Copyright (C) 2024-2025 NeXus International Advisory Committee (NIAC)
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 3 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# For further information, see http://www.nexusformat.org
-->
<definition xmlns="http://definition.nexusformat.org/nxdl/3.1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" category="base" type="group" name="NXapm_charge_state_analysis" extends="NXprocess" xsi:schemaLocation="http://definition.nexusformat.org/nxdl/3.1 ../nxdl.xsd">
    <symbols>
        <doc>
            The symbols used in the schema to specify e.g. dimensions of arrays.
        </doc>
        <symbol name="n_cand">
            <doc>
                The number of (molecular) ion candidates.
            </doc>
        </symbol>
        <symbol name="n_ivec_max">
            <doc>
                Maximum number of allowed atoms per (molecular) ion (fragment).
            </doc>
        </symbol>
        <symbol name="n_variable">
            <doc>
                Number of entries
            </doc>
        </symbol>
    </symbols>
    <doc>
        Base class to document the parameters (configuration) and results of a processing for recovering
        the charge state and nuclide composition of a (molecular) ion from ranging definitions as used
        in the research field of atom probe microscopy.
        
        A ranging definition classically reports only the mass-to-charge-state-ratio interval plus the
        elemental composition, but not necessarily the nuclide that compose the (molecular) ion.
        
        As the mass-resolving-power in an atom probe instrument is finite and typically lower
        than for cutting edge tandem mass spectrometry it is possible that different combinations of nuclides
        are indistinguishable and thus multiple (molecular) ions in eventually even different charge states
        can be valid labels for a given mass-to-charge-state-ratio peak. Enumerating the possible combinations
        is a programmatic approach that can help with peak identification.
    </doc>
    <field name="nuclides" type="NX_UINT" units="NX_UNITLESS">
        <doc>
            Parameter that defines the elements considered in the combinatorial search.
            The array contains nuclides as many times as their multiplicity and must not be empty.
            
            Nuclides are encoded using the hashing rule that is defined in :ref:`NXatom`; an example:
            A ranging definition H:2 O:1 is configured by setting nuclides to a list with entries
            :math:`1 + 0 \cdot 256`, :math:`1 + 0 \cdot 256`, :math:`8 + 0 \cdot 256`.
            Using 0 for the number of neutrons of an oxygen atom allows to encode that
            isotopes of oxygen in general are meant, i.e. the element oxygen.
            
            Constraining the elements or nuclides instead of providing all nuclides
            reduces the time to perform an exhaustive combinatorial search.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_variable"/>
        </dimensions>
    </field>
    <field name="mass_to_charge_range" type="NX_FLOAT" units="NX_ANY">
        <doc>
            Parameter that defines the interval :math:`[{m/q}_{min}, {m/q}_{max}]` within which
            (molecular) ions with given mass-to-charge-state-ratio qualify as candidates.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="2"/>
        </dimensions>
    </field>
    <field name="min_half_life" type="NX_FLOAT" units="NX_TIME">
        <doc>
            Parameter that defines the minimum half life for how long each nuclide of each
            (molecular) ion needs to be stable such that the ion qualifies as a candidate.
        </doc>
    </field>
    <field name="min_abundance" type="NX_FLOAT" units="NX_DIMENSIONLESS">
        <doc>
            Parameter that defines the minimum natural abundance of each nuclide of each
            (molecular) ion such that the ion qualifies as a candidate.
        </doc>
    </field>
    <field name="sacrifice_isotopic_uniqueness" type="NX_BOOLEAN">
        <doc>
            If the value is false, it means that non-unique solutions are accepted.
            These are solutions where multiple candidates have been built from
            different nuclide instances but the charge_state of all the ions is the same.
        </doc>
    </field>
    <field name="charge_state" type="NX_INT" units="NX_UNITLESS">
        <doc>
            Signed charge, i.e. integer multiple of the elementary
            charge of each candidate.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
    <field name="nuclide_hash" type="NX_UINT" units="NX_UNITLESS">
        <doc>
            Table of nuclide instances of which each candidate is composed.
            Each row vector is sorted in descending order.
            Unused entries in the matrix should be set to 0.
        </doc>
        <dimensions rank="2">
            <dim index="1" value="n_cand"/>
            <dim index="2" value="n_ivec_max"/>
        </dimensions>
    </field>
    <field name="mass" type="NX_FLOAT" units="NX_MASS">
        <doc>
            Accumulated mass of the nuclides in each candidate.
            Not corrected for quantum effects.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
    <field name="natural_abundance_product" type="NX_FLOAT" units="NX_DIMENSIONLESS">
        <doc>
            The product of the natural abundances of the nuclides for each candidate.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
    <field name="shortest_half_life" type="NX_FLOAT" units="NX_TIME">
        <doc>
            For each candidate the half life of the nuclide that has the
            shortest half life.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
</definition>
