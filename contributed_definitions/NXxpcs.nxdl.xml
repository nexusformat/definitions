<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="nxdlformat.xsl" ?>
<!--
# NeXus - Neutron and X-ray Common Data Format
#
# Copyright (C) 2008-2021 NeXus International Advisory Committee (NIAC)
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 3 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# For further information, see http://www.nexusformat.org
-->
<definition name="NXxpcs" extends="NXobject" type="group"
  category="application"
  xmlns="http://definition.nexusformat.org/nxdl/3.1"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://definition.nexusformat.org/nxdl/3.1 ../nxdl.xsd"
  >
  <symbols>
    <doc>
      The symbol(s) listed here will be used below to coordinate datasets with the same shape.
    </doc>
    <symbol name="nP">
      <doc>Number of points</doc>
    </symbol>
  </symbols>
  <doc>
    X-ray Photon Correlation Spectroscopy (XPCS) data (results).

    The purpose of NXxpcs is to document and communicate an accepted vernacular for various XPCS data
    in order to suppport development of community software tools.  The definition presented here only
    represents a starting point and contains fields that a common software tool should support for
    community acceptance.

    Additional fields may be added to XPCS results file (forrmally or informally).  It is expected
    that this XPCS data will be part of multi-modal data set that could involve e.g. NXcansas or
    1D and/or 2D data.

    **QUESTION** it seems we are missing the "average" image. was this intentional?
  </doc>
  <group type="NXentry" name="entry">
    <field name="definition">
      <doc> Official NeXus NXDL schema to which this file conforms </doc>
      <enumeration>
        <item value="NXxpcs"/>
      </enumeration>
    </field>

    <field name="entry_identifier">
      <doc>
        Unique identifier for the experiment.
      </doc>
    </field>
    <field name="entry_identifier_uuid" minOccurs="0" maxOccurs="1">
      <doc>
        (optional) UUID identifier for this entry.
      </doc>
    </field>
    <field name="scan_number" type="NX_INT">
      <doc>
        Scan number (must be an integer).

        NOTE: Link to collection_identifier.
      </doc>
    </field>
    <field name="start_time" type="NX_NUMBER" units="NX_DATE_TIME">
      <doc>
        Starting time of experiment, such as "2021-02-11 11:22:33.445566Z".
      </doc>
    </field>
    <field name="end_time" type="NX_NUMBER" units="NX_DATE_TIME">
      <doc>
        Ending time of experiment, such as "2021-02-11 11:23:45Z".
      </doc>
    </field>

    <group type="NXdata" name="data">
      <field name="frame_sum" type="NX_NUMBER" units="NX_COUNT" minOccurs="0" maxOccurs="1">
        <doc>
          Two-dimensional summation along the frames stack.

          sum of intensity v. time (in the units of "frames")
        </doc>
      </field>
      <field name="frame_average" type="NX_NUMBER" units="NX_COUNT" minOccurs="0" maxOccurs="1">
        <doc>
            Two-dimensional average along the frames stack.

            average intensity v. time (in the units of "frames")
        </doc>
      </field>
      <field name="g2" type="NX_NUMBER" units="NX_ARBITRARY_UNITS" minOccurs="0" maxOccurs="1">
        <doc>
            normalized intensity auto-correlation function, see Lumma, Rev. Sci. Instr. (2000), Eq 1

            ..  math:: g_2(Q,t) = \frac{ \langle I(Q,t\prime) I(Q,t|prime = t) \rangle }{ \langle I(Q,t\prime)\rangle^2 }; t > 0

            Typically, :math:`g_2` is a quantity calculated for a group of pixels reprenting a specific
            region of reciprocal space.  These groupings, or bins, are generically desribed as :math:`q`. Some
            open-source XPCS librarys refer to these bins as "rois", which are not to be confused with
            EPICS AreaDetector ROI. See usage guidelines for q_lists and roi_maps within a mask.  [#]_

            In short, :math:`g_2` should be ordered according to the roi_map value. The data should be in one
            of the following two formats:

            * iterable list of linked files for each :math:`g_2` with 1 file per :math:`q`
            * 2D array with shape (:math:`g_2`, :math:`q`)

            **QUESTION** enforcing array shape/order seems like a bad idea. NeXus has a way [#]_ to
            tag the positions.

            **QUESTION** should we add an attribute for data method (list of file links versus arrays)?

            **QUESTION** should we add a sketch of g2 plot with error bars, delay_difference, and
            baseline as an illustratory example?

            **QUESTION** should we talk more about expected length of data (we have not length
            consistency checks).  These checks are probably up to developers, but by docummenting
            here, maybe this makes it easier?

            .. TODO the next line should cite an anchor on this page about "mask".
            .. [#] mask: ``/NXxpcs/entry/instrument/masks-group``
            .. [#] NeXus 2-D data: https://manual.nexusformat.org/classes/base_classes/NXdata.html#nxdata
        </doc>
      </field>
      <field name="g2_derr" type="NX_NUMBER" units="NX_ARBITRARY_UNITS" minOccurs="0" maxOccurs="1">
        <doc>
            error values for the :math:`g_2` values.

            The derivation of the error is left up to the implemented code. Symmetric error will be
            expected (:math:`\pm` error).  The data should be in the same format as ``g2``.
        </doc>
      </field>
      <field name="G2_unnormalized" type="NX_NUMBER" units="NX_ARBITRARY_UNITS" minOccurs="0" maxOccurs="1">
        <doc>
            unnormalized intensity auto-correlation function.

            Specifically ``g2`` without the denominator.  The data should be in the same format as ``g2``.

        </doc>
      </field>
      <field name="delay_difference" type="NX_INT" units="NX_INT" minOccurs="0" maxOccurs="1">
        <doc>
          delay_difference (also known as delay or lag step)

          This is quantized difference so that the "step" between two consecutive
          frames is one frame (or step = dt = 1 frame)

          It is the "quantized" delay time corresponding to the ``g2`` values.

          The unit of delay_differences is NX_INT for units of frames (i.e. integers) preferred,
          refer to NXdetector for conversion to time units. <!-- TODO make links for NX_INT and NXdetector -->
        </doc>
      </field>
    </group>

    <group type="NXdata" name="twotime" minOccurs="0">
    <doc>
      The results in this section are higher order intensity correlations or are lower dimensional correlations
      derived from the intensity time-time correlation function (aka the two-time correlation function).
    </doc>
      <field name="two_time_corr_func" type="NX_NUMBER" units="NX_ANY" minOccurs="0" maxOccurs="1">
        <doc>
          two-time correlation of speckle intensity for a given q-bin or roi

          See Fluerasu, Phys Rev E (2007), Eq 1 and Sutton, Optics Express (2003) for the most basic
          description:

          .. math:: C(q, t_1, t_2) = \frac{ \langle I(q, t_1)I(q, t_2)\rangle }{ \langle I(q,t_1)\rangle \langle I(q,t_2)\rangle }

          in which time is quantized by frames. In short, this correlation function should be ordered
          according to the q or roi index with the origin of the 2D array at the **lower left**.  The data
          should be in one of the following two formats:

          * iterable list of linked files for each q-bin, which is a 2D array.
          * 3D array with shape (frames, frames, q)

          Other normalization methods may be applied, but the method will not be specfied in this
          defintion. Some of these normalization methods result in a baseline value of ``0``, not ``1``.

          **QUESTION** do we want to enforce lower left for origin? is this okay if the two-time
          origin is not consistent with the image origin? We will add an example 2time

          **QUESTION** 8ID data has only half populated 2time (to save on data).  Seems we need
          an attribute for this as well.


        </doc>
        <attribute name="baseline_reference" type="NX_INT">
          <doc>
            baseline is the expected value of a full decorrelation

            The baseline is a constant value added to the functional form of the auto-correlatiton
            function. This value is required.
          </doc>
          <enumeration>
            <item value="0"/>
            <item value="1"/>
          </enumeration>
        </attribute>
      </field>
      <field name="g2_from_two_time_corr_func" type="NX_NUMBER" units="NX_ARBITRARY_UNITS" minOccurs="0" maxOccurs="1">
        <doc>
          frame weighted average along the diagonal direction in ``two_time_corr_func``

          The data should be in one of the following two formats:

          * iterable list of linked files for each :math:`g_2` with 1 file per :math:`q`
          * 2D array with shape (:math:`g_2`, :math:`q`)

            Note that delay_difference is not included here because it is derived from the shape of
            extracted :math:`g_2`.

          **QUESTION** How do we deal with diagonal? Require inclusion (and leave to "fitter"
            to elminate it from exponential fit), require exclusion, allow for either with additional
            attribute?  We will appply this consistently to ``g2_from_two_time_corr_func_partials``
        </doc>
        <attribute name="baseline_reference" type="NX_INT">
          <doc>
            baseline is the expected value of a full decorrelation

            The baseline is a constant value added to the functional form of the auto-correlatiton
            function. This value is required.

          </doc>
          <enumeration>
          <item value="0"/>
          <item value="1"/>
        </enumeration>
        </attribute>
      </field>
      <field name="g2_err_from_two_time_corr_func" type="NX_NUMBER" units="NX_ARBITRARY_UNITS" minOccurs="0" maxOccurs="1">
        <doc>
            error values for the :math:`g_2` values.

            The derivation of the error is left up to the implemented code. Symmetric error will be
            expected (:math:`\pm` error).
        </doc>
      </field>
      <field name="g2_from_two_time_corr_func_partials" type="NX_NUMBER" units="NX_ARBITRARY_UNITS" minOccurs="0" maxOccurs="1">
        <doc>
          subset of frame weighted average along the diagonal direction in ``two_time_corr_func``

          Time slicing along the diagonal can be very sophisticated.  This entry currently assumes
          equal frame-binning. The expected data formats are **VERY UNCERTAIN HERE AND NEED FEEDBACK, but
          maybe this isn't a problem if we allow for customization (e.g., NXdata 2Ddata attributes)**:

          * iterable list of linked files for each parial :math:`g_2` with 1 file per :math:`q`
          * 3D array with shape (:math:`g_2`, :math:`q`, frame_binned_group)

          Note that delay_difference is not included here because it is derived from the shape of
          extrated :math:`g_2`.

          **QUESTION** Do we want a simple illustration of a two-time with markings showing bin boundaries?
        </doc>
        <attribute name="baseline_reference" type="NX_INT">
          <doc>
            baseline is the expected value of a full decorrelation

            The baseline is a constant value added to the functional form of the auto-correlatiton
            function. This value is required.
          </doc>
          <enumeration>
          <item value="0"/>
          <item value="1"/>
        </enumeration>
        </attribute>
      </field>
      <field name="g2_err_from_two_time_corr_func_partials" type="NX_NUMBER" units="NX_ARBITRARY_UNITS" minOccurs="0" maxOccurs="1">
        <doc>
            error values for the :math:`g_2` values.

            The derivation of the error is left up to the implemented code. Symmetric error will be
            expected (:math:`\pm` error).
        </doc>
      </field>
    </group>

    <group type="NXinstrument" name="instrument">
      <doc>
          XPCS instrument Metadata.

          Objects can entered here directly or linked from other
          objects in the NeXus file (such as within ``/entry/instrument``).
      </doc>
      <group type="NXbeam" name="incident_beam">
        <field name="incident_energy" type="NX_FLOAT" units="NX_ENERGY">
          <doc>Incident beam line energy (either keV or eV).</doc>
        </field>
        <field name="incident_energy_spread" type="NX_FLOAT" units="NX_ENERGY">
          <doc>
            Spread of incident beam line energy (either keV or eV). This quantity is otherwise known
            as the energy resolution, which is related to the longitudinal coherence length.
          </doc>
        </field>
        <field name="incident_polarization_type">
          <doc>
            Terse description of the incident beam polarization.

            The value can be plain text, such as ``vertical``, ``C+``,
            ``circular left``.
          </doc>
        </field>
        <field name="extent" type="NX_FLOAT" units="NX_LENGTH">
          <doc>Size (2-D) of the beam at this position.</doc>
          <!-- FIXME: (h, v) or (v, h)?  State this in the docs FOR EPICS AD, likeky v, h.  But seems CSX is (h,v) if looking
          from the source's perspective at the face of the detector - see fig 11 and fig 12 of cxidb documentation-->
        </field>
      </group>

      <group type="NXdetector" name="detector">
        <doc>
          XPCS data is typically produced by an areadetector as a stack of 2D images. Sometimes
          this data is represented in different ways (sparse arrays or photon event list), but this detail
          is left to the analysis software.  Therefore, we only include We note that the image origin
          (pixel coordinates (0,0)) are found at the top left of a single 2D image array. This
          is the standard expected by  <a href="https://cxidb.org/cxi.html">Coherent X-ray Imaging Data Bank</a>.
          See CXI version 1.6 and Maia, Nature Methods (2012).

          Additionally, all but ``frame_time`` are inhereited from NXdetector. ``frame_time`` is used to
          convert ``delay_difference`` to seconds.

          **QUESTION** It seems this top-left is matplotlib default and informal convention of AreaDetector.
          However, in reading the CXI documentation, top-left is the example in Fig 11. Fig 12 shows
          it is perspective dependant. We need to make a decision here - do we always convert or do
          we add attributes that allows someone to convert to CXI format (speckle oversampling for single frame CDI)
        </doc>
        <field name="description">
          <doc>Detector name.</doc>
        </field>
        <field name="distance" type="NX_NUMBER" units="NX_LENGTH">
          <doc>Distance between sample and detector.</doc>
        </field>
        <field name="count_time" type="NX_NUMBER" units="NX_TIME">
          <doc>Exposure time of frames, s.</doc>
        </field>
        <field name="frame_time" type="NX_NUMBER" units="NX_TIME">
          <doc>
            Exposure period (time between frame starts) of frames, s
          </doc>
        </field>
        <field name="beam_center_x" type="NX_NUMBER" units="NX_LENGTH">
          <doc>
            Position of beam center, x axis, in detector's coordinates.
          </doc>
        </field>
        <field name="beam_center_y" type="NX_NUMBER" units="NX_LENGTH">
          <doc>
            Position of beam center, y axis, in detector's coordinates.
          </doc>
        </field>
        <field name="x_pixel_size" type="NX_NUMBER" units="NX_LENGTH">
          <doc>
            Length of pixel in x direction.
          </doc>
        </field>
        <field name="y_pixel_size" type="NX_NUMBER" units="NX_LENGTH">
          <doc>
            Length of pixel in y direction.
          </doc>
        </field>
      </group>

      <group type="NXnote" name="masks" minOccurs="0" maxOccurs="1">
          <doc>
              Data masks or mappings to regions of interest (roi) for specific :math:`Q` values

              Fields in this ``masks`` group describe regions of interest
              in the data by either a mask to select pixels or to associate
              a *map* of ROIs with a (one-dimensional) *list* of values.

              "roi_maps" provide for represention of pixel binning that are arbitrary and irregular,
              which is geometry scattering agnostic and most flexible.

              "Dynamic" represents quantities directly related to XPCS and NXxcps/entry/data and
              NXxpcs/entry/two_time.

              "Static" refers to finerbinning used for computation not directly related to the final
              XPCS results. Implementation of "static" binning is left for individual libraries to
              document.  We encouurage usage of NXcansas to represent standard SAXS results or
              developmnet of new NeXus defintions for GI-SAXS or other reciprocal space
              intensity mapping.
          </doc>
          <field name="dynamic_roi_map" type="NX_DIMENSIONLESS">
            <doc>
            roi index array or labeled array

            The values of this mask index (or map to) the :math:`Q` value from the
            the ``dynamic_q_list`` field. Not that the value of ``0`` represents in-action. XPCS computations
            are performed on all pixels with a value > 0.

            The ``units`` attribute should be set to ``"au"``
            indicating arbitrary units.
            </doc>
          </field>
          <field name="dynamic_q_list" type="NX_NUMBER" units="NX_PER_LENGTH" minOccurs="0">
            <doc>
            1-D list of :math:`Q` values, one for each roi index value.

            List order is determined by the index value of the associated roi map starting at ``1``.

            The only requirement for the list is that it may be iterable. Some expected formats are:

            * iterable list of floats (i.e., :math:`Q(r)`)
            * iterable list of tuples (e.g., (H, K, L); (qx, qy, qz); (horizontal_pixel, vertical_pixel))
            * iterable list of integers or strings
            </doc>
          </field>
          <field name="dynamic_phi_list" type="NX_NUMBER" units="NX_PER_LENGTH" minOccurs="0">
            <doc>
            Array of :math:`\varphi` value for each pixel.

            List order is determined by the index value of the associated roi map starting at ``1``.
            </doc>
          </field>
          <field name="static_roi_map" type="NX_DIMENSIONLESS" minOccurs="0">
            <doc>
            roi index array.

            The values of this mask index the :math:`|Q|` value from the
            the ``static_q_list`` field.

            The ``units`` attribute should be set to ``"au"``
            indicating arbitrary units.
            </doc>
          </field>
          <field name="static_q_list" type="NX_NUMBER" units="NX_PER_LENGTH">
            <doc>
            1-D list of :math:`|Q|` values, 1 for each ROI.
            </doc>
          </field>
      </group>
    </group>

    <group type="NXsample" name="sample" minOccurs="0">
      Describes the minimum requirements regarding equilbrium sample conditions. NXsample
      permits other quantities (e.g., applied fields, crystallographic information, name, etc) that
      may optionally be include for equilibrium conditions (which is not exclusively equilibrium
      dynamics from XPCS analysis).

      For non-equilibrrium sample conditions (i.e., changing sample or process conditions
      during the XPCS measurement) will require either a new entry or an additional atttribute.
      <field name="temperature_set" type="NX_NUMBER" units="NX_TEMPERATURE" minOccurs="0">
        <doc>
          Sample temperature setpoint, (C or K).
        </doc>
      </field>
      <field name="temperature" type="NX_NUMBER" units="NX_TEMPERATURE" minOccurs="0">
        <doc>
          Sample temperature actual, (C or K).
        </doc>
      </field>
      <group type="NXpositioner" name="position_x" minOccurs="0" />
      <group type="NXpositioner" name="position_y" minOccurs="0" />
      <group type="NXpositioner" name="position_z" minOccurs="0" />
    </group>

    <group type="NXnote" name="ROI" minOccurs="0" maxOccurs="unbounded">
      <doc>
        Region(s) of interest.

        NAME: The NeXus convention, to use all upper case
        to indicate the name (here ``roi``), is left to the file
        writer.  In our case, follow the suggested name
        pattern and sequence: roi_1, roi_2, roi_3, ...
        Start with ``roi_1`` if the first one, otherwise
        pick the next number in this sequence.
      </doc>
    </group>

    <group type="NXnote" name="NOTE" minOccurs="0" maxOccurs="unbounded">
      <doc>
        Any other notes.

        NAME: The NeXus convention, to use all upper case
        to indicate the name (here ``NOTE``), is left to the file
        writer.  In our case, follow the suggested name
        pattern and sequence: note_1, note_2, note_3, ...
        Start with ``note_1`` if the first one, otherwise
        pick the next number in this sequence.
      </doc>
    </group>
  </group>
</definition>
