<?xml version='1.0' encoding='UTF-8'?>
<?xml-stylesheet type="text/xsl" href="nxdlformat.xsl"?>
<!--
# NeXus - Neutron and X-ray Common Data Format
#
# Copyright (C) 2014-2024 NeXus International Advisory Committee (NIAC)
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 3 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# For further information, see http://www.nexusformat.org
-->
<definition xmlns="http://definition.nexusformat.org/nxdl/3.1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" category="base" type="group" name="NXapm_charge_state_analysis" extends="NXprocess" xsi:schemaLocation="http://definition.nexusformat.org/nxdl/3.1 ../nxdl.xsd">
    <symbols>
        <doc>
             The symbols used in the schema to specify e.g. dimensions of arrays.
        </doc>
        <symbol name="n_cand">
            <doc>
                 The number of also possible but different (molecular) ions.
            </doc>
        </symbol>
        <symbol name="n_ivec_max">
            <doc>
                 Maximum number of allowed atoms per (molecular) ion (fragment).
            </doc>
        </symbol>
    </symbols>
    <doc>
         Base class to document an algorithm for recovering charge state and nuclid composition of a (molecular) ion.
         
         Currently ranging definitions in the research field of atom probe face have limitations:
         
         1. A ranging definition maps all signal within a mass-to-charge-state-ratio value interval
            on one iontype. Facing limited mass-resolving-power, there are mass-to-charge-state-ratio
            values, though, for which not only multiple (molecular) ions are indistinguishable but
            also for which the current practice of documenting classical ranging definitions is incomplete.
         2. Indeed, ranging definitions often report only (for each interval) the
            mass-to-charge-state-ratio intervals surplus the composition of elements
            that build the (molecular) ion.
         3. Therefore, classical ranging definitions demand a post-processing with an algorithm
            which can identify the nuclids from which the (molecular) ion is constructed
            and a charge state possibly recovered.
            Combinatorial algorithms are used for this purpose.
         
         This base class documents the configuration and results of such an algorithm.
    </doc>
    <!--Details and results of the combinatorial analyses of a ranging definition
to clarify (if possible) the charge_state of an ion and its (not necessarily)
unique combination of nuclids contained including their multiplicity.
input/config-->
    <field name="element_vector" type="NX_UINT" units="NX_UNITLESS">
        <doc>
             Input constraint, list of proton numbers for each element of the ranging
             definition. The list contains each element as many times as its multiplicity.
             As an example a ranging definition H:2 O:1 demands element vector
             to be 1, 1, 8. An empty list does not release the constraint.
             Instead, a list with all elements in the periodic table should be
             used. Keep in mind though with such a weakly constrained parameter space
             the combinatorial analysis may become very time consuming!
        </doc>
        <dimensions rank="1">
            <dim index="1" value="i"/>
        </dimensions>
    </field>
    <field name="mass_to_charge_range" type="NX_FLOAT" units="NX_ANY">
        <doc>
             Input constraint, interval within which (molecular) ions need to have the
             mass-to-charge-state-ratio such that an ion qualifies as a candidate.
        </doc>
        <dimensions rank="2">
            <dim index="1" value="1"/>
            <dim index="2" value="2"/>
        </dimensions>
    </field>
    <field name="min_half_life" type="NX_FLOAT" units="NX_TIME">
        <doc>
             Input constraint, minimum half life for how long each nuclid of each
             (molecular) ion needs to be stable such that the ion qualifies as a candidate.
        </doc>
    </field>
    <field name="min_abundance" type="NX_FLOAT" units="NX_DIMENSIONLESS">
        <doc>
             Input constraint, minimum natural abundance of each nuclid of each
             (molecular) ion such that the ion qualifies as a candidate.
        </doc>
    </field>
    <field name="sacrifice_isotopic_uniqueness" type="NX_BOOLEAN">
        <doc>
             If the value is false, it means that non-unique solutions are accepted.
             These are solutions where multiple candidates have been built from different
             nuclids but the charge_state of all the ions is the same.
        </doc>
    </field>
    <!--min_abundance_product(NX_FLOAT):
  doc: |
    For each candidate TO BE DEFINED.
  unit: NX_DIMENSIONLESS
  dim: (n_cand,)
output/results
the n_cand can be 1 in which case all quantities below are scalar-->
    <field name="charge_state_vector" type="NX_INT" units="NX_UNITLESS">
        <doc>
             Signed charge, i.e. integer multiple of the elementary charge.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
    <field name="isotope_matrix" type="NX_UINT" units="NX_UNITLESS">
        <doc>
             List of nuclids building each candidate.
             Each list is sorted in descending order.
             Unused values up to n_ivec_max are nullified.
        </doc>
        <dimensions rank="2">
            <dim index="1" value="n_cand"/>
            <dim index="2" value="n_ivec_max"/>
        </dimensions>
    </field>
    <field name="mass_vector" type="NX_FLOAT" units="NX_MASS">
        <doc>
             Accumulated mass of the nuclids in each candidate.
             Not corrected for quantum effects.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
    <field name="natural_abundance_product_vector" type="NX_FLOAT" units="NX_DIMENSIONLESS">
        <doc>
             The product of the natural abundances of the nuclids for each candidate.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
    <field name="min_half_life_vector" type="NX_FLOAT" units="NX_TIME">
        <doc>
             For each candidate the half life of the nuclid with the shortest half life.
        </doc>
        <dimensions rank="1">
            <dim index="1" value="n_cand"/>
        </dimensions>
    </field>
</definition>
