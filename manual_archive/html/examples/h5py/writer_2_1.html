


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>h5py example writing a simple NeXus data file with links &mdash; NeXus: Manual 3.2 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/blockquote.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="NeXus: Manual 3.2 documentation" href="../../index.html" />
    <link rel="up" title="2.1.2. Python Examples using h5py" href="index.html" />
    <link rel="next" title="2.1.3. MATLAB Examples" href="../matlab/index.html" />
    <link rel="prev" title="h5py example writing the simplest NeXus data file" href="writer_1_3.html" /> 
    <link rel="stylesheet" href="../../_static/blockquote.css" type="text/css" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../matlab/index.html" title="2.1.3. MATLAB Examples"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="writer_1_3.html" title="h5py example writing the simplest NeXus data file"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">NeXus: Manual 3.2 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >2. Examples of writing and reading NeXus data files</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2.1.2. Python Examples using <code class="docutils literal"><span class="pre">h5py</span></code></a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/nexuslogo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><code class="docutils literal"><span class="pre">h5py</span></code> example writing a simple NeXus data file with links</a><ul>
<li><a class="reference internal" href="#downloads">downloads</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="writer_1_3.html"
                        title="previous chapter"><code class="docutils literal"><span class="pre">h5py</span></code> example writing the simplest NeXus data file</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../matlab/index.html"
                        title="next chapter">2.1.3. MATLAB Examples</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/examples/h5py/writer_2_1.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div id="google_search" style="display: none">
	<hr />
	<h3>Google search</h3>
	<form method="get" action="http://www.google.com/search">
		<table border="0" align="center" cellpadding="0">
			<tr>
				<td>
					<input type="text"   name="q" value="" />
				</td>
			</tr>
			<tr>
				<td align="center" style="font-size:75%">
					<input type="radio"  name="sitesearch" value="" />global
					<input type="radio"  name="sitesearch"
						value="download.nexusformat.org" 
						checked />NeXus manual
					<input type="submit" value="Go" />
					<br />
				</td>
			</tr>
		</table>
	</form>                                
</div>
<script type="text/javascript">$('#google_search').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="h5py-example-writing-a-simple-nexus-data-file-with-links">
<span id="example-writer-2-1"></span><h1><code class="docutils literal"><span class="pre">h5py</span></code> example writing a simple NeXus data file with links<a class="headerlink" href="#h5py-example-writing-a-simple-nexus-data-file-with-links" title="Permalink to this headline">¶</a></h1>
<p>Building on the previous example, we wish to identify our measured data with
the detector on the instrument where it was generated.
In this hypothetical case, since the detector was positioned at some
angle <em>two_theta</em>, we choose to store both datasets,
<code class="docutils literal"><span class="pre">two_theta</span></code> and <code class="docutils literal"><span class="pre">counts</span></code>, in a NeXus group.
One appropriate NeXus group is <a class="reference internal" href="../../classes/base_classes/NXdetector.html#nxdetector"><span>NXdetector</span></a>.
This group is placed in a <a class="reference internal" href="../../classes/base_classes/NXinstrument.html#nxinstrument"><span>NXinstrument</span></a> group
which is placed in a <a class="reference internal" href="../../classes/base_classes/NXentry.html#nxentry"><span>NXentry</span></a> group.
Still, NeXus requires a <a class="reference internal" href="../../classes/base_classes/NXdata.html#nxdata"><span>NXdata</span></a> group.
Rather than duplicate the same data already placed in the detector group,
we choose to link to those datasets from the <code class="docutils literal"><span class="pre">NXdata</span></code> group.
(Compare the next figure with <a class="reference internal" href="../../design.html#fig-data-linking"><span>Linking in a NeXus file</span></a> in the
<a class="reference internal" href="../../design.html#design"><span>NeXus Design</span></a> chapter of the NeXus User Manual.)
The <a class="reference internal" href="../../design.html#design"><span>NeXus Design</span></a> chapter provides a figure
(<a class="reference internal" href="../../design.html#fig-data-linking"><span>Linking in a NeXus file</span></a>) with a small variation from our
previous example, placing the measured data
within the <code class="docutils literal"><span class="pre">/entry/instrument/detector</span></code> group.
Links are made from that data to the <code class="docutils literal"><span class="pre">/entry/data</span></code> group.</p>
<div class="compound">
<div class="compound-last figure" id="id1">
<span id="fig-writer-2-1"></span><a class="reference internal image-reference" href="../../_images/ex_writer_2_1.png"><img alt="fig.writer_2_1" src="../../_images/ex_writer_2_1.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text">h5py example showing linking in a NeXus file</span></p>
</div>
</div>
<p>The Python code to build an HDF5 data file with that structure (using
numerical data from the previous example) is shown below.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Writes a simple NeXus HDF5 file using h5py with links</span>
<span class="sd">according to the example from Figure 2.1 in the Design chapter</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;input.dat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">tthData</span> <span class="o">=</span> <span class="nb">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                             <span class="c"># float[]</span>
<span class="n">countsData</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;int32&#39;</span><span class="p">)</span>   <span class="c"># int[]</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s">&#39;writer_2_1.hdf5&#39;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>  <span class="c"># create the HDF5 NeXus file</span>
<span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;entry&#39;</span>

<span class="n">nxentry</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s">&#39;entry&#39;</span><span class="p">)</span>
<span class="n">nxentry</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;NX_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;NXentry&#39;</span>
<span class="n">nxentry</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;data&#39;</span>

<span class="n">nxinstrument</span> <span class="o">=</span> <span class="n">nxentry</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s">&#39;instrument&#39;</span><span class="p">)</span>
<span class="n">nxinstrument</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;NX_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;NXinstrument&#39;</span>

<span class="n">nxdetector</span> <span class="o">=</span> <span class="n">nxinstrument</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s">&#39;detector&#39;</span><span class="p">)</span>
<span class="n">nxdetector</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;NX_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;NXdetector&#39;</span>

<span class="c"># store the data in the NXdetector group</span>
<span class="n">ds_tth</span> <span class="o">=</span> <span class="n">nxdetector</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">&#39;two_theta&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">tthData</span><span class="p">)</span>
<span class="n">ds_tth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;degrees&#39;</span>
<span class="n">ds_counts</span> <span class="o">=</span> <span class="n">nxdetector</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">&#39;counts&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">countsData</span><span class="p">)</span>
<span class="n">ds_counts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;counts&#39;</span>

<span class="c"># create the NXdata group to define the default plot</span>
<span class="n">nxdata</span> <span class="o">=</span> <span class="n">nxentry</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
<span class="n">nxdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;NX_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;NXdata&#39;</span>
<span class="n">nxdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;counts&#39;</span>
<span class="n">nxdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;axes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;two_theta&#39;</span>
<span class="n">nxdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;two_theta_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span>

<span class="n">source_addr</span> <span class="o">=</span> <span class="s">&#39;/entry/instrument/detector/two_theta&#39;</span>    <span class="c"># existing data</span>
<span class="n">target_addr</span> <span class="o">=</span> <span class="s">&#39;two_theta&#39;</span>                               <span class="c"># new location</span>
<span class="n">ds_tth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_addr</span>                    <span class="c"># a NeXus API convention for links</span>
<span class="n">nxdata</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">source_addr</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5g</span><span class="o">.</span><span class="n">LINK_HARD</span><span class="p">)</span>

<span class="n">source_addr</span> <span class="o">=</span> <span class="s">&#39;/entry/instrument/detector/counts&#39;</span>       <span class="c"># existing data</span>
<span class="n">target_addr</span> <span class="o">=</span> <span class="s">&#39;counts&#39;</span>                                  <span class="c"># new location</span>
<span class="n">ds_counts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_addr</span>                 <span class="c"># a NeXus API convention for links</span>
<span class="n">nxdata</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">source_addr</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5g</span><span class="o">.</span><span class="n">LINK_HARD</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>   <span class="c"># be CERTAIN to close the file</span>
</pre></div>
</td></tr></table></div>
<p>It is interesting to compare the output of the <code class="docutils literal"><span class="pre">h5dump</span></code>
of the data file <code class="docutils literal"><span class="pre">writer_2_1.hdf5</span></code> with our Python instructions.
See the <em>downloads</em> section below.</p>
<p>Look carefully!  It <em>appears</em> in the output of
<code class="docutils literal"><span class="pre">h5dump</span></code> that the actual data for <code class="docutils literal"><span class="pre">two_theta</span></code>
and <code class="docutils literal"><span class="pre">counts</span></code> has <em>moved</em> into
the <code class="docutils literal"><span class="pre">NXdata</span></code> group at HDF5 path <code class="docutils literal"><span class="pre">/entry/data</span></code>!  But we stored
that data in the <code class="docutils literal"><span class="pre">NXdetector</span></code> group at <code class="docutils literal"><span class="pre">/entry/instrument/detector</span></code>.
This is normal for <code class="docutils literal"><span class="pre">h5dump</span></code> output.</p>
<p>A bit of explanation is necessary at this point.
The data is not stored in either HDF5 group directly.  Instead, HDF5
creates a <code class="docutils literal"><span class="pre">DATA</span></code> storage element in the file and posts a reference
to that <code class="docutils literal"><span class="pre">DATA</span></code> storage element as needed.
An HDF5 <em>hard link</em>
requests another reference to that same <code class="docutils literal"><span class="pre">DATA</span></code> storage element.
The <code class="docutils literal"><span class="pre">h5dump</span></code> tool describes in full that <code class="docutils literal"><span class="pre">DATA</span></code> storage element
the first time (alphabetically) it is called.  In our case, that is within the
<code class="docutils literal"><span class="pre">NXdata</span></code> group.  The next time it is called, within the
<code class="docutils literal"><span class="pre">NXdetector</span></code> group, <code class="docutils literal"><span class="pre">h5dump</span></code> reports that a hard link
has been made and shows the HDF5 path to the description.</p>
<p>NeXus recognizes this behavior of the HDF5 library and adds an additional structure
when building hard links, the <code class="docutils literal"><span class="pre">target</span></code> attribute,
to preserve the original location of the data.  Not that it actually matters.
The <code class="docutils literal"><span class="pre">h5toText.py</span></code> tool knows about the additional NeXus
<code class="docutils literal"><span class="pre">target</span></code> attribute and shows the data to appear in its original
location, in the <code class="docutils literal"><span class="pre">NXdetector</span></code> group.</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre>writer_2_1.hdf5
  @default = entry
  entry:NXentry
    @NX_class = NXentry
    @default = data
    data:NXdata
      @NX_class = NXdata
      @signal = counts
      @axes = two_theta
      @two_theta_indices = [0]
      counts --&gt; /entry/instrument/detector/counts
      two_theta --&gt; /entry/instrument/detector/two_theta
    instrument:NXinstrument
      @NX_class = NXinstrument
      detector:NXdetector
        @NX_class = NXdetector
        counts:int32[31] = [1037, 1318, 1704, &#39;...&#39;, 1321]
          @units = counts
          @target = /entry/instrument/detector/counts
        two_theta:float64[31] = [17.926079999999999, 17.925909999999998, 17.925750000000001, &#39;...&#39;, 17.92108]
          @units = degrees
          @target = /entry/instrument/detector/two_theta
</pre></div>
</td></tr></table></div>
<div class="section" id="downloads">
<h2>downloads<a class="headerlink" href="#downloads" title="Permalink to this headline">¶</a></h2>
<p>The Python code and files related to this section may be downloaded from the following table.</p>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">file</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference download internal" href="../../_downloads/writer_2_1.py"><code class="xref download docutils literal"><span class="pre">writer_2_1.py</span></code></a></td>
<td>python code to write example <em>writer_2_1</em></td>
</tr>
<tr class="row-odd"><td><a class="reference download internal" href="../../_downloads/writer_2_1.hdf5"><code class="xref download docutils literal"><span class="pre">writer_2_1.hdf5</span></code></a></td>
<td>NeXus file written by this code</td>
</tr>
<tr class="row-even"><td><a class="reference download internal" href="../../_downloads/writer_2_1_h5dump.txt"><code class="xref download docutils literal"><span class="pre">writer_2_1_h5dump.txt</span></code></a></td>
<td><em>h5dump</em> analysis of the NeXus file</td>
</tr>
<tr class="row-odd"><td><a class="reference download internal" href="../../_downloads/writer_2_1_structure.txt"><code class="xref download docutils literal"><span class="pre">writer_2_1_structure.txt</span></code></a></td>
<td><em>h5toText</em> analysis of the NeXus file</td>
</tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../matlab/index.html" title="2.1.3. MATLAB Examples"
             >next</a> |</li>
        <li class="right" >
          <a href="writer_1_3.html" title="h5py example writing the simplest NeXus data file"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">NeXus: Manual 3.2 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >2. Examples of writing and reading NeXus data files</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2.1.2. Python Examples using <code class="docutils literal"><span class="pre">h5py</span></code></a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; <a href="../../copyright.html">Copyright</a> 1996-2016, http://nexusformat.org.
      Last updated on 2016-11-22 16:55:48 CET.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>